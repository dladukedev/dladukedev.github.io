<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tape Calc</title>
  <script type="text/javascript" src="./math.js"></script>

  <style>
    body {
      margin: 32px;
    }

    #tape {
      font-family: monospace;
      white-space: pre;
    }

    #current {
      font-family: monospace;
    }

    #content {
      display: grid;
      gap: 16px;
      grid-template-areas:
        "current tape"
        "functions tape"
        "calculator tape"
        "memory-actions memory";
      place-content: center;
    }

    @media(max-width: 520px) {
      #content {
        grid-template-areas:
          "tape"
          "current"
          "functions"
          "calculator"
          "memory-actions"
          "memory";
      }
    }

    #current-area {
      grid-area: current;
      border: 1px solid black;
      padding: 8px;
      display: flex;
      justify-content: end;
    }

    #tape-area {
      grid-area: tape;
      border: 1px solid black;
      padding: 8px;
      display: grid;
      height: 225px;
      overflow-y: scroll;
    }

    #tape-area-content {
      display: grid;
      place-content: end;
    }

    #calculator-area {
      grid-area: calculator;
      display: grid;
      gap: 8px;
      grid-template:
        "seven eight nine . divide" 25px
        "four five six . multiply" 25px
        "one two three . subtract" 25px
        "zero double-zero decimal . add" 25px
        "triple-zero triple-zero invert . equals" 25px
      ;
      grid-template-columns: repeat(3, 1fr) 8px 1fr;
    }

    #one {
      grid-area: one;
    }

    #two {
      grid-area: two;
    }

    #three {
      grid-area: three;
    }

    #four {
      grid-area: four;
    }

    #five {
      grid-area: five;
    }

    #six {
      grid-area: six;
    }

    #seven {
      grid-area: seven;
    }

    #eight {
      grid-area: eight;
    }

    #nine {
      grid-area: nine;
    }

    #zero {
      grid-area: zero;
    }

    #double-zero {
      grid-area: double-zero;
    }

    #triple-zero {
      grid-area: triple-zero;
    }

    #decimal {
      grid-area: decimal;
    }

    #invert {
      grid-area: invert;
    }

    #add {
      grid-area: add;
    }

    #subtract {
      grid-area: subtract;
    }

    #multiply {
      grid-area: multiply;
    }

    #divide {
      grid-area: divide;
    }

    #equals {
      grid-area: equals;
    }

    #clear-actions-area {
      grid-area: functions;
      display: grid;
      grid-auto-flow: column;
      gap: 8px;
      grid-template-columns: repeat(4, 1fr);
    }

    #copy-button {
      position: absolute;
    }

    #memory-actions-area {
      grid-area: memory-actions;
      display: grid;
      grid-auto-flow: column;
      gap: 8px;
      grid-template-columns: repeat(4, 1fr);
    }

    #memory-area {
      grid-area: memory;
      border: 1px solid black;
      padding: 4px 8px;
      display: flex;
      justify-content: end;
      font-family: monospace;
    }
  </style>
</head>

<body>
  <div id="content">
    <div id="current-area">
      <div id="current">0</div>
    </div>

    <div id="clear-actions-area">
      <button onclick="backspace()">Back</button>
      <button onclick="clearAll()">C</button>
      <button onclick="clearTape()">CT</button>
      <button onclick="clearEntry()">CE</button>
    </div>

    <div id="calculator-area">
      <button id="zero" onclick="appendNumber(0)">0</button>
      <button id="one" onclick="appendNumber(1)">1</button>
      <button id="two" onclick="appendNumber(2)">2</button>
      <button id="three" onclick="appendNumber(3)">3</button>
      <button id="four" onclick="appendNumber(4)">4</button>
      <button id="five" onclick="appendNumber(5)">5</button>
      <button id="six" onclick="appendNumber(6)">6</button>
      <button id="seven" onclick="appendNumber(7)">7</button>
      <button id="eight" onclick="appendNumber(8)">8</button>
      <button id="nine" onclick="appendNumber(9)">9</button>

      <button id="double-zero" onclick="doubleZero()">00</button>
      <button id="triple-zero" onclick="tripleZero()">000</button>
      <button id="decimal" onclick="decimal()">.</button>
      <button id="invert" onclick="invert()">+/-</button>

      <button id="add" onclick="appendOperation('ADD')">+</button>
      <button id="subtract" onclick="appendOperation('SUB')">-</button>
      <button id="multiply" onclick="appendOperation('MUL')">x</button>
      <button id="divide" onclick="appendOperation('DIV')">÷</button>

      <button id="equals" onclick="equals()">=</button>
    </div>

    <div id="tape-area">
      <div id="tape-area-content">
        <div id="tape">
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        </div>
        <button id="copy-button" onclick="copyTape()">⧉</button>
      </div>
    </div>

    <div id="memory-actions-area">
      <button onclick="memoryClear()">MC</button>
      <button onclick="memoryRecall()">MR</button>
      <button onclick="memoryStore()">MS</button>
      <button onclick="memoryAdd()">M+</button>
      <button onclick="memorySubtract()">M-</button>
    </div>

    <div id="memory-area">
      <div id="memory">MEM: 0</div>
    </div>
  </div>

  <script>
    math.config({
      number: 'BigNumber',
      precision: 16,
    })

    const OPERATION = {
      ADD: 'ADD',
      SUB: 'SUB',
      DIV: 'DIV',
      MUL: 'MUL',
      INIT: 'INIT',
      EQUALS: 'EQUALS',
    }

    const COPY_TAPE_RESULT = {
      SUCCESS: 'SUCCESS',
      ERROR: 'ERROR',
      NONE: 'NONE'
    }

    const createStore = (initialState, reducer = {}, subscribers = [], middleware = []) => {
      let state = initialState

      const getState = () => state

      const dispatch = (action) => {
        action = middleware.reduce((act, mw) => mw(act, state, dispatch), action)

        let prevState = state;

        if (action) {
          state = reducer[action.type]?.(state, action) ?? state
        }

        subscribers.forEach(sub => sub(state, prevState))
      }

      return {
        dispatch,
        getState,
      }
    }

    // State
    const initialState = {
      lineSize: 30,
      memory: math.bignumber(0),
      log: [],
      current: {
        num: '',
        op: OPERATION.INIT
      },
      copyTapeResult: COPY_TAPE_RESULT.NONE
    }

    // Selectors
    const currentValueSelector = (state) => state.current.num
    const currentOpSelector = (state) => state.current.op
    const currentBigNumSelector = (state) => {
      const currentNumValue = currentValueSelector(state)
      return currentNumValue ? math.bignumber(currentNumValue) : math.bignumber(0)
    }
    const currentValueEmptySelector = (state) => !state.current.num.length
    const runningTotalSelector = (state) => {
      const log = logSelector(state)

      return log.reduce((total, {op, num}) => {
        return op === OPERATION.ADD ? total.add(num)
          : op === OPERATION.SUB ? total.subtract(num)
            : op === OPERATION.MUL ? total.multiply(num)
              : op === OPERATION.DIV ? total.divide(num)
                : op === OPERATION.INIT ? math.chain(num)
                  : op === OPERATION.EQUALS ? math.chain(num)
                    : math.chain(0)
      }, math.chain(math.bignumber(0))).done()
    }
    const currentDisplayValueSelector = (state) => {
      const currentValue = currentValueSelector(state)
      const currentTotal = currentTotalSelector(state)
      const currentOp = currentOpSelector(state)

      var displayValue = currentValue
      if (displayValue === '') {
        const runningTotal = runningTotalSelector(state)
        displayValue = runningTotal
      }

      return displayValue || '0'
    }
    const currentDisplayBigNumberSelector = (state) => {
      const currentDisplayValue = currentDisplayValueSelector(state)
      return math.bignumber(currentDisplayValue)
    }

    const logSelector = (state) => state.log ?? []
    const isLogClearedSelector = (state) => state.log === null
    const memoryValueSelector = (state) => state.memory
    const lineSizeSelector = (state) => state.lineSize


    const currentTotalSelector = (state) => state.log?.findLast(item => item.op === OPERATION.EQUALS)?.num

    const tapeContentSelector = (state) => {
      const lineSize = lineSizeSelector(state)
      const log = logSelector(state)

      if (!log.length) return "".padStart(lineSize, ' ')

      const formatLine = (num, sign) => {
        return (numberFormat(num) + ' ' + sign).padStart(lineSize, ' ')
      }

      const text = log.map(({op, num}) => {
        switch (op) {
          case OPERATION.ADD:
            return formatLine(num, '+')

          case OPERATION.SUB:
            return formatLine(num, '-')

          case OPERATION.MUL:
            return formatLine(num, 'x')

          case OPERATION.DIV:
            return formatLine(num, '÷')

          case OPERATION.INIT:
            return '\n' + formatLine(num, ' ')

          case OPERATION.EQUALS:
            return '-'.repeat(lineSize) + '\n' + formatLine(num, '=')

          default:
            throw `ERROR! Unknown operation ${op}`
        }
      })

      return text.join("\n").substring(1)
    }

    // Reducers
    const handleDecimal = (state, action) => {
      const currentNum = currentValueSelector(state)

      if (currentNum.includes('.')) {
        return state
      }

      return {
        ...state,
        current: {
          ...state.current,
          num: currentNum + '.'
        }
      }
    }

    const handleInvert = (state, action) => {
      const currentNum = currentValueSelector(state)

      if (!currentNum.length) return state

      const newCurrentNum = currentNum[0] === '-' ? currentNum.substring(1) : `-${currentNum}`

      return {
        ...state,
        current: {
          ...state.current,
          num: newCurrentNum
        }
      }
    }

    const handleAppendNumber = (state, {payload: {num}}) => {
      const currentNum = currentValueSelector(state)
      const isAppendingZero = num.toString() === '0'
      const isCurrentNumZero = currentNum.toString() === '0'

      let newNum = currentNum + num.toString()
      if (isCurrentNumZero && isAppendingZero) {
        newNum = currentNum
      } else if (currentNum === '' && isAppendingZero) {
        newNum = '0'
      } else if (isCurrentNumZero && !isAppendingZero) {
        newNum = num.toString()
      }

      return {
        ...state,
        current: {
          ...state.current,
          num: newNum
        }
      }
    }

    const handleDoubleZero = (state, action) => {
      const currentNum = currentValueSelector(state)
      const isCurrentNumZero = currentNum.toString() === '0'

      let newNum = currentNum + '00'
      if (isCurrentNumZero) {
        newNum = currentNum
      } else if (currentNum === '') {
        newNum = '0'
      }

      return {
        ...state,
        current: {
          ...state.current,
          num: newNum
        }
      }
    }

    const handleTripleZero = (state, action) => {
      const currentNum = currentValueSelector(state)
      const isCurrentNumZero = currentNum.toString() === '0'

      let newNum = currentNum + '000'
      if (isCurrentNumZero) {
        newNum = currentNum
      } else if (currentNum === '') {
        newNum = '0'
      }

      return {
        ...state,
        current: {
          ...state.current,
          num: newNum
        }
      }
    }

    const handleAppendOperation = (state, {payload: {op}}) => {
      const log = logSelector(state)
      const currentValue = currentValueSelector(state)
      const currentNum = currentBigNumSelector(state)
      const currentOp = currentOpSelector(state)

      if (currentValue === '' && log.length) {
        return {
          ...state,
          current: {
            ...state.current,
            op: op
          }
        }

      } else {
        const newLog = log.length
          ? [...log, {num: currentNum, op: currentOp}]
          : [{num: currentNum, op: OPERATION.INIT}]

        return {
          ...state,
          log: newLog,
          current: {
            num: '',
            op: op
          }
        }
      }

    }

    const handleEquals = (state, action) => {
      const log = logSelector(state)
      const currentValue = currentValueSelector(state)
      const currentOp = currentOpSelector(state)

      let newLog = [...log]
      if (currentValue !== '' && currentOp) {
        const currentNum = currentBigNumSelector(state)

        newLog = log.length
          ? [...log, {num: currentNum, op: currentOp}]
          : [{num: currentNum, op: OPERATION.INIT}]
      }

      const intermediateState = {
        ...state,
        log: newLog,
      }

      const total = runningTotalSelector(intermediateState)

      newLog = [...newLog, {num: total, op: OPERATION.EQUALS}]

      return {
        ...state,
        current: {
          num: '',
          op: OPERATION.INIT
        },
        log: newLog,
      }
    }

    const handleBackspace = (state, action) => {
      const currentNum = currentValueSelector(state)

      return {
        ...state,
        current: {
          ...state.current,
          num: currentNum.substring(0, currentNum.length - 1)
        }
      }
    }

    const handleClearEntry = (state, action) => {
      return {
        ...state,
        current: {
          ...state.current,
          num: '0',
        }
      }
    }

    const handleClearTape = (state, action) => {
      const current = currentDisplayValueSelector(state)

      return {
        ...state,
        log: null,
        current: {
          num: current,
          op: OPERATION.INIT
        }
      }
    }

    const handleClearAll = (state, action) => {
      return {
        ...state,
        log: null,
        current: {
          num: '',
          op: OPERATION.INIT
        }
      }
    }

    const handleMemoryClear = (state, action) => {
      return {
        ...state,
        memory: math.bignumber(0)
      }
    }

    const handleMemoryAdd = (state, action) => {
      const currentNum = currentDisplayBigNumberSelector(state)
      const memory = memoryValueSelector(state)

      return {
        ...state,
        memory: math.add(memory, currentNum)
      }
    }

    const handleMemorySubtract = (state, action) => {
      const currentNum = currentDisplayBigNumberSelector(state)
      const memory = memoryValueSelector(state)

      return {
        ...state,
        memory: math.subtract(memory, currentNum)
      }
    }

    const handleMemoryStore = (state, action) => {
      const currentNum = currentDisplayBigNumberSelector(state)

      return {
        ...state,
        memory: currentNum
      }
    }

    const handleMemoryRecall = (state, action) => {
      const memory = memoryValueSelector(state)

      return {
        ...state,
        current: {
          ...state.current,
          num: memory.toString()
        }
      }
    }

    const handleCopyTape = (state, action) => {
      return {
        ...state,
        copyTapeResult: COPY_TAPE_RESULT.NONE
      }
    }

    const handleCopyTapeSuccess = (state, action) => {
      return {
        ...state,
        copyTapeResult: COPY_TAPE_RESULT.SUCCESS
      }
    }

    const handleCopyTapeError = (state, action) => {
      return {
        ...state,
        copyTapeResult: COPY_TAPE_RESULT.ERROR
      }
    }

    const handleCopyTapeClear = (state, action) => {
      return {
        ...state,
        copyTapeResult: COPY_TAPE_RESULT.NONE
      }
    }

    const reducer = {
      decimal: handleDecimal,
      invert: handleInvert,
      appendNumber: handleAppendNumber,
      doubleZero: handleDoubleZero,
      tripleZero: handleTripleZero,
      appendOperation: handleAppendOperation,
      equals: handleEquals,
      backspace: handleBackspace,
      clearEntry: handleClearEntry,
      clearTape: handleClearTape,
      clearAll: handleClearAll,
      memoryClear: handleMemoryClear,
      memoryAdd: handleMemoryAdd,
      memorySubtract: handleMemorySubtract,
      memoryStore: handleMemoryStore,
      memoryRecall: handleMemoryRecall,
      copyTape: handleCopyTape,
      copyTapeSuccess: handleCopyTapeSuccess,
      copyTapeError: handleCopyTapeError,
      copyTapeClear: handleCopyTapeClear,
    }

    // Actions
    const appendNumberAction = (num) => ({type: "appendNumber", payload: {num}})
    const appendOperationAction = (op) => ({type: "appendOperation", payload: {op}})

    const decimalAction = () => ({type: "decimal"})
    const invertAction = () => ({type: "invert"})
    const doubleZeroAction = () => ({type: "doubleZero"})
    const tripleZeroAction = () => ({type: "tripleZero"})
    const equalsAction = () => ({type: "equals"})

    const backspaceAction = () => ({type: "backspace"})
    const clearEntryAction = () => ({type: "clearEntry"})
    const clearTapeAction = () => ({type: "clearTape"})
    const clearAllAction = () => ({type: "clearAll"})

    const memoryClearAction = () => ({type: "memoryClear"})
    const memoryAddAction = () => ({type: "memoryAdd"})
    const memorySubtractAction = () => ({type: "memorySubtract"})
    const memoryStoreAction = () => ({type: "memoryStore"})
    const memoryRecallAction = () => ({type: "memoryRecall"})

    const copyTapeAction = () => ({type: "copyTape"})
    const copyTapeSuccessAction = () => ({type: "copyTapeSuccess"})
    const copyTapeErrorAction = () => ({type: "copyTapeError"})
    const copyTapeClearAction = () => ({type: "copyTapeClear"})

    // Subscribers
    const numberFormat = (num) => {
      const numStr = num.toString()

      const [integer, decimal] = numStr.split('.')

      const formattedInteger = integer.replace(/\B(?=(\d{3})+(?!\d))/g, ",")

      return decimal ? `${formattedInteger}.${decimal}` : formattedInteger

      return [formattedInteger, decimal].filter(x => !!x).join('.')
    }

    const renderCurrent = (state) => {
      const current = document.getElementById("current")
      const display = currentDisplayValueSelector(state)
      current.innerHTML = numberFormat(display)
    }

    const renderTape = (state, prevState) => {
      const tapeArea = document.getElementById("tape-area")
      const tape = document.getElementById("tape")
      const copyButton = document.getElementById("copy-button")
      const lineSize = lineSizeSelector(state)

      const log = logSelector(state)
      const prevLog = logSelector(prevState)

      const wasCleared = isLogClearedSelector(state)
      if (wasCleared) {
        tape.innerHTML = "CLEARED".padStart(lineSize, ' ')
        return
      }

      const tapeContent = tapeContentSelector(state)

      tape.innerHTML = tapeContent

      if (log !== prevLog) {
        tapeArea.scrollTo(0, tapeArea.scrollHeight)
      }

      if (state.copyTapeResult === COPY_TAPE_RESULT.SUCCESS) {
        copyButton.innerHTML = '⧉ - Copied!'
      } else if (state.copyTapeResult === COPY_TAPE_RESULT.ERROR) {
        copyButton.innerHTML = '⧉ - Failed!'
      } else {
        copyButton.innerHTML = '⧉'
      }
    }

    const renderMemory = (state) => {
      const memory = document.getElementById("memory")
      const memoryValue = memoryValueSelector(state)
      memory.innerHTML = "MEM: " + numberFormat(memoryValue)
    }

    let copyTimeout = null
    const copyTapeMiddleware = (action, state, dispatch) => {
      if (action.type === "copyTape") {
        clearTimeout(copyTimeout)
        copyTimeout = null

        const tape = tapeContentSelector(state)

        navigator.clipboard.writeText(tape)
          .then(() => dispatch(copyTapeSuccessAction()))
          .catch((err) => {
            console.error('Failed to copy text:', err)
            dispatch(copyTapeErrorAction())
          })
      } else if (action.type === "copyTapeSuccess" || action.type === 'copyTapeError') {
        clearTimeout(copyTimeout)
        copyTimeout = setTimeout(() => dispatch(copyTapeClearAction()), 3000)
      } else if (action.type === "copyTapeClear") {
        clearTimeout(copyTimeout)
        copyTimeout = null
      }

      return action
    }

    const subscribers = [renderCurrent, renderTape, renderMemory]
    const middleware = [copyTapeMiddleware]

    const store = createStore(initialState, reducer, subscribers, middleware)

    const increment = () => {store.dispatch(incrementAction())}

    renderCurrent(store.getState(), store.getState())
    renderMemory(store.getState(), store.getState())
    renderTape(store.getState(), store.getState())

    // Tests
    const test = () => {
      const testState = {counter: 0, actions: 0}

      const assert = (func, expected, actual) => {
        if (actual === expected) {
          console.log(`${func}: Success!!`)
        } else {
          console.error(`${func}: ${actual} !== ${expected}`)
        }
      }

      const increment_increases_count = () => {
        // Given
        const underTest = createStore(testState, reducer)
        const expected = 1

        // When
        underTest.dispatch(incrementAction())
        const actual = countSelector(underTest.getState())

        // Then
        assert(increment_increases_count.name, expected, actual)
      }

      increment_increases_count()
    }

    const backspace = () => store.dispatch(backspaceAction())
    const clearAll = () => store.dispatch(clearAllAction())
    const clearTape = () => store.dispatch(clearTapeAction())
    const clearEntry = () => store.dispatch(clearEntryAction())
    const appendNumber = (num) => store.dispatch(appendNumberAction(num))
    const doubleZero = () => store.dispatch(doubleZeroAction())
    const tripleZero = () => store.dispatch(tripleZeroAction())
    const decimal = () => store.dispatch(decimalAction())
    const invert = () => store.dispatch(invertAction())
    const appendOperation = (op) => store.dispatch(appendOperationAction(op))
    const equals = () => store.dispatch(equalsAction())
    const copyTape = () => store.dispatch(copyTapeAction())
    const memoryClear = () => store.dispatch(memoryClearAction())
    const memoryRecall = () => store.dispatch(memoryRecallAction())
    const memoryStore = () => store.dispatch(memoryStoreAction())
    const memoryAdd = () => store.dispatch(memoryAddAction())
    const memorySubtract = () => store.dispatch(memorySubtractAction())

    const handleKeyboardEvent = (key) => {
      switch (key) {
        case '1':
        case '2':
        case '3':
        case '4':
        case '5':
        case '6':
        case '7':
        case '8':
        case '9':
        case '0':
          store.dispatch(appendNumberAction(key))
          break
        case "+":
          store.dispatch(appendOperationAction(OPERATION.ADD))
          break
        case "-":
          store.dispatch(appendOperationAction(OPERATION.SUB))
          break
        case "*":
          store.dispatch(appendOperationAction(OPERATION.MUL))
          break
        case "/":
          store.dispatch(appendOperationAction(OPERATION.DIV))
          break
        case "c":
          store.dispatch(clearAllAction())
          break
        case "=":
        case "Enter":
          store.dispatch(equalsAction())
          break
        case '.':
          store.dispatch(decimalAction())
          break
        case "Backspace":
          store.dispatch(backspaceAction())
          break
      }
    }

    document.addEventListener('keydown', function (event) {
      handleKeyboardEvent(event.key)
      event.preventDefault()
    });
  </script>
</body>

</html>
