<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tape Calc</title>
  <script type="text/javascript" src="./math.js"></script>

  <style>
    #tape {
      font-family: monospace;
      white-space: pre;
    }

    #current {
      font-family: monospace;
    }

    #content {
      display: grid;
      gap: 16px;
      grid-template-areas:
        "current tape"
        "functions tape"
        "calculator tape"
        "memory-actions memory";
      place-content: center;
    }

    #current-area {
      grid-area: current;
      border: 1px solid black;
      padding: 8px;
      display: flex;
      justify-content: end;
    }

    #tape-area {
      grid-area: tape;
      border: 1px solid black;
      padding: 8px;
      display: grid;
      place-content: end;
    }

    #calculator-area {
      grid-area: calculator;
      display: grid;
      gap: 8px;
      grid-template:
        "seven eight nine . divide" 25px
        "four five six . multiply" 25px
        "one two three . subtract" 25px
        "zero double-zero decimal . add" 25px
        "triple-zero triple-zero invert . equals" 25px
      ;
      grid-template-columns: repeat(3, 1fr) 8px 1fr;
    }

    #one {
      grid-area: one;
    }

    #two {
      grid-area: two;
    }

    #three {
      grid-area: three;
    }

    #four {
      grid-area: four;
    }

    #five {
      grid-area: five;
    }

    #six {
      grid-area: six;
    }

    #seven {
      grid-area: seven;
    }

    #eight {
      grid-area: eight;
    }

    #nine {
      grid-area: nine;
    }

    #zero {
      grid-area: zero;
    }

    #double-zero {
      grid-area: double-zero;
    }

    #triple-zero {
      grid-area: triple-zero;
    }

    #decimal {
      grid-area: decimal;
    }

    #invert {
      grid-area: invert;
    }

    #add {
      grid-area: add;
    }

    #subtract {
      grid-area: subtract;
    }

    #multiply {
      grid-area: multiply;
    }

    #divide {
      grid-area: divide;
    }

    #equals {
      grid-area: equals;
    }

    #clear-actions-area {
      grid-area: functions;
      display: grid;
      grid-auto-flow: column;
      gap: 8px;
      grid-template-columns: repeat(4, 1fr);
    }

    #copy-button {
      position: absolute;
    }

    #memory-actions-area {
      grid-area: memory-actions;
      display: grid;
      grid-auto-flow: column;
      gap: 8px;
      grid-template-columns: repeat(4, 1fr);
    }

    #memory-area {
      grid-area: memory;
      border: 1px solid black;
      padding: 4px 8px;
      display: flex;
      justify-content: end;
      font-family: monospace;
    }
  </style>
</head>

<body>
  <div id="content">
    <div id="current-area">
      <div id="current">0</div>
    </div>

    <div id="clear-actions-area">
      <button onclick="backspace()">Back</button>
      <button onclick="clearAll()">C</button>
      <button onclick="clearTape()">CT</button>
      <button onclick="clearEntry()">CE</button>
    </div>

    <div id="calculator-area">
      <button id="zero" onclick="appendNumber(0)">0</button>
      <button id="one" onclick="appendNumber(1)">1</button>
      <button id="two" onclick="appendNumber(2)">2</button>
      <button id="three" onclick="appendNumber(3)">3</button>
      <button id="four" onclick="appendNumber(4)">4</button>
      <button id="five" onclick="appendNumber(5)">5</button>
      <button id="six" onclick="appendNumber(6)">6</button>
      <button id="seven" onclick="appendNumber(7)">7</button>
      <button id="eight" onclick="appendNumber(8)">8</button>
      <button id="nine" onclick="appendNumber(9)">9</button>

      <button id="double-zero" onclick="doubleZero()">00</button>
      <button id="triple-zero" onclick="tripleZero()">000</button>
      <button id="decimal" onclick="decimal()">.</button>
      <button id="invert" onclick="invert()">+/-</button>

      <button id="add" onclick="appendOperation('ADD')">+</button>
      <button id="subtract" onclick="appendOperation('SUB')">-</button>
      <button id="multiply" onclick="appendOperation('MUL')">x</button>
      <button id="divide" onclick="appendOperation('DIV')">÷</button>

      <button id="equals" onclick="equals()">=</button>
    </div>

    <div id="tape-area">
      <div id="tape">
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      </div>
      <button id="copy-button" onclick="copyTape()">⧉</button>
    </div>

    <div id="memory-actions-area">
      <button onclick="memoryClear()">MC</button>
      <button onclick="memoryRecall()">MR</button>
      <button onclick="memoryStore()">MS</button>
      <button onclick="memoryAdd()">M+</button>
      <button onclick="memorySubtract()">M-</button>
    </div>

    <div id="memory-area">
      <div id="memory">MEM: 0</div>
    </div>
  </div>

  <script>
    math.config({
      number: 'BigNumber',
    })

    const OPERATION = {
      ADD: 'ADD',
      SUB: 'SUB',
      DIV: 'DIV',
      MUL: 'MUL',
      INIT: 'INIT'
    }

    const createStore = (initialState, reducer = {}, subscribers = [], middleware = []) => {
      let state = initialState

      const getState = () => state

      const dispatch = (action) => {
        action = middleware.reduce((act, mw) => mw(act, state), action)

        let prevState = state;

        if (action) {
          state = reducer[action.type]?.(state, action) ?? state
        }

        subscribers.forEach(sub => sub(state, prevState))
      }

      return {
        dispatch,
        getState,
      }
    }

    // State
    const initialState = {
      lineSize: 30,
      memory: math.bignumber(0),
      log: [],
      current: {
        num: '',
        op: OPERATION.INIT
      },
    }

    // Selectors
    const currentValueSelector = (state) => state.current.num
    const currentOpSelector = (state) => state.current.op
    const currentBigNumSelector = (state) => {
      const currentNumValue = currentValueSelector(state)
      return currentNumValue ? math.bignumber(currentNumValue) : math.bignumber(0)
    }
    const currentValueEmptySelector = (state) => !state.current.num.length || state.current.num === '0'
    const logSelector = (state) => state.log ?? []
    const isLogClearedSelector = (state) => state.log === null
    const memoryValueSelector = (state) => state.memory
    const lineSizeSelector = (state) => state.lineSize
    const tapeContentSelector = (state) => {
      const lineSize = lineSizeSelector(state)
      const log = logSelector(state)

      if (!log.length) return "".padStart(lineSize, ' ')

      let text = ""
      let total = math.chain(math.bignumber(0))

      log.forEach(({op, num}) => {
        let sign = ' '

        switch (op) {
          case OPERATION.ADD:
            total = total.add(num)
            sign = '+'
            break

          case OPERATION.SUB:
            total = total.subtract(num)
            sign = '-'
            break

          case OPERATION.MUL:
            total = total.multiply(num)
            sign = 'x'
            break

          case OPERATION.DIV:
            total = total.divide(num)
            sign = '÷'
            break

          case OPERATION.INIT:
            total = total.add(num)
            sign = ' '
            break

          default:
            throw `ERROR! Unknown operation ${op}`
        }

        const line = numberFormat(num) + ' ' + sign

        text += "\n" + line.padStart(lineSize, ' ')
      })

      text += '\n' + '-'.repeat(lineSize) + '\n'
      totalString = numberFormat(total.done())
      text += (totalString + ' =').padStart(lineSize, ' ')

      return text.substring(1)
    }

    // Reducers
    const handleDecimal = (state, action) => {
      const currentNum = currentValueSelector(state)

      if (currentNum.includes('.')) {
        return state
      }

      return {
        ...state,
        current: {
          ...state.current,
          num: currentNum + '.'
        }
      }
    }

    const handleInvert = (state, action) => {
      const currentNum = currentValueSelector(state)

      if (!currentNum.length) return state

      const newCurrentNum = currentNum[0] === '-' ? currentNum.substring(1) : `-${currentNum}`

      return {
        ...state,
        current: {
          ...state.current,
          num: newCurrentNum
        }
      }
    }

    const handleAppendNumber = (state, {payload: {num}}) => {
      const isEmpty = currentValueEmptySelector(state)
      const isAppendingZero = num.toString() === '0'

      if (isEmpty && isAppendingZero) {
        return state
      }

      const currentNum = currentValueSelector(state)

      return {
        ...state,
        current: {
          ...state.current,
          num: currentNum + num.toString()
        }
      }
    }

    const handleDoubleZero = (state, action) => {
      const isEmpty = currentValueEmptySelector(state)
      if (isEmpty) {
        return state
      }

      const currentNum = currentValueSelector(state)

      return {
        ...state,
        current: {
          ...state.current,
          num: currentNum + '00'
        }
      }
    }

    const handleTripleZero = (state, action) => {
      const isEmpty = currentValueEmptySelector(state)
      if (isEmpty) {
        return state
      }

      const currentNum = currentValueSelector(state)

      return {
        ...state,
        current: {
          ...state.current,
          num: currentNum + '000'
        }
      }
    }

    const handleAppendOperation = (state, {payload: {op}}) => {
      const log = logSelector(state)
      const currentNum = currentBigNumSelector(state)
      const currentOp = currentOpSelector(state)

      const newLog = log.length
        ? [...log, {num: currentNum, op: currentOp}]
        : [{num: currentNum, op: OPERATION.INIT}]

      return {
        ...state,
        log: newLog,
        current: {
          num: '',
          op: op
        }
      }
    }

    const handleEquals = (state, action) => {
      const log = logSelector(state)
      const currentNum = currentBigNumSelector(state)
      const currentOp = currentOpSelector(state)

      const newLog = log.length
        ? [...log, {num: math.bignumber(currentNum), op: currentOp}]
        : [{num: math.bignumber(currentNum), op: OPERATION.INIT}]

      return {
        ...state,
        log: newLog,
      }
    }

    const handleBackspace = (state, action) => {
      const currentNum = currentValueSelector(state)

      return {
        ...state,
        current: {
          ...state.current,
          num: currentNum.substring(0, currentNum.length - 1)
        }
      }
    }

    const handleClearEntry = (state, action) => {
      return {
        ...state,
        current: {
          num: '',
          op: OPERATION.INIT
        }
      }
    }

    const handleClearTape = (state, action) => {
      return {
        ...state,
        log: null,
      }
    }

    const handleClearAll = (state, action) => {
      return {
        ...state,
        log: null,
        current: {
          num: '',
          op: OPERATION.INIT
        }
      }
    }

    const handleMemoryClear = (state, action) => {
      return {
        ...state,
        memory: math.bignumber(0)
      }
    }

    const handleMemoryAdd = (state, action) => {
      const currentNum = currentBigNumSelector(state)
      const memory = memoryValueSelector(state)

      return {
        ...state,
        memory: math.add(memory, currentNum)
      }
    }

    const handleMemorySubtract = (state, action) => {
      const currentNum = currentBigNumSelector(state)
      const memory = memoryValueSelector(state)

      return {
        ...state,
        memory: math.subtract(memory, currentNum)
      }
    }

    const handleMemoryStore = (state, action) => {
      const currentNum = currentBigNumSelector(state)

      return {
        ...state,
        memory: currentNum
      }
    }

    const handleMemoryRecall = (state, action) => {
      const memory = memoryValueSelector(state)

      return {
        ...state,
        current: {
          ...state.current,
          num: memory.toString()
        }
      }
    }

    const reducer = {
      decimal: handleDecimal,
      invert: handleInvert,
      appendNumber: handleAppendNumber,
      doubleZero: handleDoubleZero,
      tripleZero: handleTripleZero,
      appendOperation: handleAppendOperation,
      equals: handleEquals,
      backspace: handleBackspace,
      clearEntry: handleClearEntry,
      clearTape: handleClearTape,
      clearAll: handleClearAll,
      memoryClear: handleMemoryClear,
      memoryAdd: handleMemoryAdd,
      memorySubtract: handleMemorySubtract,
      memoryStore: handleMemoryStore,
      memoryRecall: handleMemoryRecall
    }

    // Actions
    const appendNumberAction = (num) => ({type: "appendNumber", payload: {num}})
    const appendOperationAction = (op) => ({type: "appendOperation", payload: {op}})

    const decimalAction = () => ({type: "decimal"})
    const invertAction = () => ({type: "invert"})
    const doubleZeroAction = () => ({type: "doubleZero"})
    const tripleZeroAction = () => ({type: "tripleZero"})
    const equalsAction = () => ({type: "equals"})

    const backspaceAction = () => ({type: "backspace"})
    const clearEntryAction = () => ({type: "clearEntry"})
    const clearTapeAction = () => ({type: "clearTape"})
    const clearAllAction = () => ({type: "clearAll"})

    const memoryClearAction = () => ({type: "memoryClear"})
    const memoryAddAction = () => ({type: "memoryAdd"})
    const memorySubtractAction = () => ({type: "memorySubtract"})
    const memoryStoreAction = () => ({type: "memoryStore"})
    const memoryRecallAction = () => ({type: "memoryRecall"})

    const copyTapeAction = () => ({type: "copyTape"})

    // Subscribers
    const numberFormat = (num) => {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",")
    }

    const renderCurrent = (state) => {
      const current = document.getElementById("current")
      const currentValue = currentValueSelector(state) || '0'
      current.innerHTML = numberFormat(currentValue)
    }

    const renderTape = (state, prevState) => {
      const tape = document.getElementById("tape")
      const lineSize = lineSizeSelector(state)

      const log = logSelector(state)

      const wasCleared = isLogClearedSelector(state)
      if (wasCleared) {
        tape.innerHTML = "CLEARED".padStart(lineSize, ' ')
        return
      }

      const tapeContent = tapeContentSelector(state)

      tape.innerHTML = tapeContent
    }

    const renderMemory = (state) => {
      const memory = document.getElementById("memory")
      const memoryValue = memoryValueSelector(state)
      memory.innerHTML = "MEM: " + numberFormat(memoryValue)
    }

    const copyTapeMiddleware = (action, state) => {
      if (action.type === "copyTape") {
        const tape = tapeContentSelector(state)
        navigator.clipboard.writeText(tape)
          .then(() => alert('Copied!'))
          .catch((err) => console.error('Failed to copy text:', err))

        return null
      }

      return action
    }

    const subscribers = [renderCurrent, renderTape, renderMemory]
    const middleware = [copyTapeMiddleware]

    const store = createStore(initialState, reducer, subscribers, middleware)

    const increment = () => {store.dispatch(incrementAction())}

    renderCurrent(store.getState(), store.getState())
    renderMemory(store.getState(), store.getState())
    renderTape(store.getState(), store.getState())

    // Tests
    const test = () => {
      const testState = {counter: 0, actions: 0}

      const assert = (func, expected, actual) => {
        if (actual === expected) {
          console.log(`${func}: Success!!`)
        } else {
          console.error(`${func}: ${actual} !== ${expected}`)
        }
      }

      const increment_increases_count = () => {
        // Given
        const underTest = createStore(testState, reducer)
        const expected = 1

        // When
        underTest.dispatch(incrementAction())
        const actual = countSelector(underTest.getState())

        // Then
        assert(increment_increases_count.name, expected, actual)
      }

      increment_increases_count()
    }

    const backspace = () => store.dispatch(backspaceAction())
    const clearAll = () => store.dispatch(clearAllAction())
    const clearTape = () => store.dispatch(clearTapeAction())
    const clearEntry = () => store.dispatch(clearEntryAction())
    const appendNumber = (num) => store.dispatch(appendNumberAction(num))
    const doubleZero = () => store.dispatch(doubleZeroAction())
    const tripleZero = () => store.dispatch(tripleZeroAction())
    const decimal = () => store.dispatch(decimalAction())
    const invert = () => store.dispatch(invertAction())
    const appendOperation = (op) => store.dispatch(appendOperationAction(op))
    const equals = () => store.dispatch(equalsAction())
    const copyTape = () => store.dispatch(copyTapeAction())
    const memoryClear = () => store.dispatch(memoryClearAction())
    const memoryRecall = () => store.dispatch(memoryRecallAction())
    const memoryStore = () => store.dispatch(memoryStoreAction())
    const memoryAdd = () => store.dispatch(memoryAddAction())
    const memorySubtract = () => store.dispatch(memorySubtractAction())

    const handleKeyboardEvent = (key) => {
      switch (key) {
        case '1':
        case '2':
        case '3':
        case '4':
        case '5':
        case '6':
        case '7':
        case '8':
        case '9':
        case '0':
          store.dispatch(appendNumberAction(key))
          break
        case "+":
          store.dispatch(appendOperationAction(OPERATION.ADD))
          break
        case "-":
          store.dispatch(appendOperationAction(OPERATION.SUB))
          break
        case "*":
          store.dispatch(appendOperationAction(OPERATION.MUL))
          break
        case "/":
          store.dispatch(appendOperationAction(OPERATION.DIV))
          break
        case "c":
          store.dispatch(clearAllAction())
          break
        case "=":
        case "Enter":
          store.dispatch(equalsAction())
          break
        case '.':
          store.dispatch(decimalAction())
          break
        case "Backspace":
          store.dispatch(backspaceAction())
          break
      }
    }

    document.addEventListener('keydown', function (event) {
      handleKeyboardEvent(event.key)
    });
  </script>
</body>

</html>
